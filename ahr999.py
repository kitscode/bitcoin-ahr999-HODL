import requests, json, time, math
from scipy import stats
import csv

'''
ahr999囤币指标:
计算方式：ahr999指标 =（比特币价格/200日定投成本）*（比特币价格/指数增长估值）。
其中指数成长估值为币价和币龄的拟合结果，本指数拟合方法为每月对历史数据进行拟合。

指标说明：该指标由微博用户ahr999创建，辅助比特币定投用户结合择机策略做出投资决策。 
该指标隐含了比特币短期定投的收益率及比特币价格与预期估值的偏离度。 
从长期来看，比特币价格与区块高度呈现出一定的正相关，同时借助定投方式的优势，短期定投成本大都位于比特币价格之下。 
因此，当比特币价格同时低于短期定投成本和预期估值时增大投资额，能增大用户收益的概率。 
根据指标回测，当指标低于0.45时适合抄底，在0.45和1.2区间内适合定投BTC，高于该区间意味着错过最佳定投时期。
'''

def ahr999():
    geomean = stats.gmean([8112.13, 7479.35, 7575, 7450])
    # api地址
    url = 'https://api.coincap.io/v2/candles?exchange=huobi&interval=d1&baseId=bitcoin&quoteId=tether&start=1559520000000&end=1584275033726'

    # 网络请求
    r = requests.get(url)
    jsonstr = {
        "data": [
            {
                "open": "0.0708000000000000",
                "high": "0.0710450000000000",
                "low": "0.0706434000000000",
                "close": "0.0708350100000000",
                "volume": "1818.1433015300000000",
                "period": 1530720000000
            },
            {
                "open": "0.0708316700000000",
                "high": "0.0715192000000000",
                "low": "0.0706544100000000",
                "close": "0.0712472600000000",
                "volume": "1649.2534471200000000",
                "period": 1530748800000
            },
            {
                "open": "0.0712452600000000",
                "high": "0.0717550000000000",
                "low": "0.0709818600000000",
                "close": "0.0713202600000000",
                "volume": "1727.3015548300000000",
                "period": 1530777600000
            },
            {
                "open": "0.0713400000000000",
                "high": "0.0716440200000000",
                "low": "0.0709436400000000",
                "close": "0.0716373500000000",
                "volume": "832.2377254200000000",
                "period": 1530806400000
            },
            {
                "open": "0.0716852400000000",
                "high": "0.0717850000000000",
                "low": "0.0700000000000000",
                "close": "0.0703750000000000",
                "volume": "2791.1439402600000000",
                "period": 1530835200000
            },
            {
                "open": "0.0703750000000000",
                "high": "0.0714796800000000",
                "low": "0.0702492000000000",
                "close": "0.0712949900000000",
                "volume": "1878.1581776500000000",
                "period": 1530864000000
            },
            {
                "open": "0.0711771600000000",
                "high": "0.0717000000000000",
                "low": "0.0708528700000000",
                "close": "0.0711200000000000",
                "volume": "1368.7725389300000000",
                "period": 1530892800000
            },
            {
                "open": "0.0711300000000000",
                "high": "0.0714714300000000",
                "low": "0.0707802600000000",
                "close": "0.0712365000000000",
                "volume": "865.5540202300000000",
                "period": 1530921600000
            },
            {
                "open": "0.0712364900000000",
                "high": "0.0716181400000000",
                "low": "0.0708000000000000",
                "close": "0.0711000100000000",
                "volume": "1228.4198248600000000",
                "period": 1530950400000
            },
            {
                "open": "0.0711894700000000",
                "high": "0.0718431700000000",
                "low": "0.0702000000000000",
                "close": "0.0718431700000000",
                "volume": "2143.3020698900000000",
                "period": 1530979200000
            },
            {
                "open": "0.0719900000000000",
                "high": "0.0731662700000000",
                "low": "0.0717050100000000",
                "close": "0.0719200000000000",
                "volume": "1663.2797136100000000",
                "period": 1531008000000
            },
            {
                "open": "0.0719250000000000",
                "high": "0.0729799900000000",
                "low": "0.0718556400000000",
                "close": "0.0727000100000000",
                "volume": "1462.4665687900000000",
                "period": 1531036800000
            },
            {
                "open": "0.0727000100000000",
                "high": "0.0729700000000000",
                "low": "0.0721251500000000",
                "close": "0.0724850100000000",
                "volume": "1809.6590769100000000",
                "period": 1531065600000
            },
            {
                "open": "0.0725550000000000",
                "high": "0.0726932200000000",
                "low": "0.0715000100000000",
                "close": "0.0719300000000000",
                "volume": "1489.4695856800000000",
                "period": 1531094400000
            },
            {
                "open": "0.0719350000000000",
                "high": "0.0720063800000000",
                "low": "0.0712516100000000",
                "close": "0.0714000000000000",
                "volume": "1305.2166636100000000",
                "period": 1531123200000
            },
            {
                "open": "0.0713949900000000",
                "high": "0.0714000000000000",
                "low": "0.0706850100000000",
                "close": "0.0707060000000000",
                "volume": "1757.5901286100000000",
                "period": 1531152000000
            },
            {
                "open": "0.0706850100000000",
                "high": "0.0709288900000000",
                "low": "0.0690000000000000",
                "close": "0.0692376500000000",
                "volume": "4134.9898355400000000",
                "period": 1531180800000
            },
            {
                "open": "0.0692004800000000",
                "high": "0.0695000000000000",
                "low": "0.0674380600000000",
                "close": "0.0690250000000000",
                "volume": "4217.5220123100000000",
                "period": 1531209600000
            },
            {
                "open": "0.0690250000000000",
                "high": "0.0692500000000000",
                "low": "0.0681924800000000",
                "close": "0.0686250000000000",
                "volume": "1564.4274571600000000",
                "period": 1531238400000
            },
            {
                "open": "0.0686302400000000",
                "high": "0.0689979800000000",
                "low": "0.0676004000000000",
                "close": "0.0687697400000000",
                "volume": "1897.3264469400000000",
                "period": 1531267200000
            },
            {
                "open": "0.0686358400000000",
                "high": "0.0699000000000000",
                "low": "0.0685351500000000",
                "close": "0.0691300000000000",
                "volume": "3554.7047582000000000",
                "period": 1531296000000
            },
            {
                "open": "0.0690850000000000",
                "high": "0.0699119000000000",
                "low": "0.0686500200000000",
                "close": "0.0697500000000000",
                "volume": "1254.6803122500000000",
                "period": 1531324800000
            },
            {
                "open": "0.0696900000000000",
                "high": "0.0701733300000000",
                "low": "0.0691920000000000",
                "close": "0.0698973300000000",
                "volume": "1560.8181853000000000",
                "period": 1531353600000
            },
            {
                "open": "0.0698973300000000",
                "high": "0.0702000000000000",
                "low": "0.0691950900000000",
                "close": "0.0697030000000000",
                "volume": "4291.7702089600000000",
                "period": 1531382400000
            },
            {
                "open": "0.0697029900000000",
                "high": "0.0701000000000000",
                "low": "0.0686529500000000",
                "close": "0.0688606500000000",
                "volume": "1700.7687711700000000",
                "period": 1531411200000
            },
            {
                "open": "0.0688604300000000",
                "high": "0.0700562200000000",
                "low": "0.0688604300000000",
                "close": "0.0698850000000000",
                "volume": "4853.9876114100000000",
                "period": 1531440000000
            },
            {
                "open": "0.0698652400000000",
                "high": "0.0704701500000000",
                "low": "0.0697304100000000",
                "close": "0.0700050000000000",
                "volume": "1717.8862759500000000",
                "period": 1531468800000
            },
            {
                "open": "0.0699774400000000",
                "high": "0.0700500000000000",
                "low": "0.0693500000000000",
                "close": "0.0694784500000000",
                "volume": "1700.4209570200000000",
                "period": 1531497600000
            },
            {
                "open": "0.0695054900000000",
                "high": "0.0697200000000000",
                "low": "0.0692284000000000",
                "close": "0.0694482600000000",
                "volume": "819.9396176500000000",
                "period": 1531526400000
            },
            {
                "open": "0.0694512800000000",
                "high": "0.0699999800000000",
                "low": "0.0693163000000000",
                "close": "0.0697800000000000",
                "volume": "513.2843779900000000",
                "period": 1531555200000
            },
            {
                "open": "0.0697800000000000",
                "high": "0.0701231000000000",
                "low": "0.0690950200000000",
                "close": "0.0693935200000000",
                "volume": "1018.4489863700000000",
                "period": 1531584000000
            },
            {
                "open": "0.0692600000000000",
                "high": "0.0696019800000000",
                "low": "0.0690873800000000",
                "close": "0.0694412600000000",
                "volume": "427.9522534700000000",
                "period": 1531612800000
            },
            {
                "open": "0.0694450000000000",
                "high": "0.0709350000000000",
                "low": "0.0694400000000000",
                "close": "0.0709350000000000",
                "volume": "1189.5625595600000000",
                "period": 1531641600000
            },
            {
                "open": "0.0709350000000000",
                "high": "0.0711370000000000",
                "low": "0.0704796500000000",
                "close": "0.0706550000000000",
                "volume": "640.3759941800000000",
                "period": 1531670400000
            }
        ],
        "timestamp": 1533581190540
    }

    data = jsonstr['data']
    lows = []
    for item in data:  # 打印出所有的keys
        lows.append((float(item['low'])))
        geomean = stats.gmean(lows)
        day = (item['period'] / 1000 - 1230940800) / (24 * 60 * 60)
        coinPrice = 10 ** (5.84 * math.log(day, 10) - 17.01)
        ahr999 = (float(item['low']) / geomean) * (float(item['low']) / coinPrice)
        print(item, ahr999, day, coinPrice, geomean)


if __name__ == '__main__':
    ahr999()
